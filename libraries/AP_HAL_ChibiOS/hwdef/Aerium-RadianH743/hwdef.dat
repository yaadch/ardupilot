# hw definition file for processing by chibios_pins.py
# for Aerium Radian H743

# MCU class and specific type
MCU STM32H7xx STM32H743xx

# board ID for firmware load
APJ_BOARD_ID 91

# crystal frequency, setup to use external oscillator
OSCILLATOR_HZ 8000000

FLASH_SIZE_KB 2048
env OPTIMIZE -Os

# bootloader takes first sector
FLASH_RESERVE_START_KB 128


# ChibiOS system timer
STM32_ST_USE_TIMER 12
define CH_CFG_ST_RESOLUTION 16

# USB
PA11 OTG_FS_DM OTG1
PA12 OTG_FS_DP OTG1

# SWD
PA13 JTMS-SWDIO SWD
PA14 JTCK-SWCLK SWD

# SPI1 for IMU1 (BMI270), BARO1 (LPS2XH)
PB3 SPI1_SCK SPI1
PB4 SPI1_MISO SPI1
PD7 SPI1_MOSI SPI1

# SPI1 for IMU2 (ICM42688P), BARO2 (BMP280)
PB13 SPI2_SCK SPI2
PB14 SPI2_MISO SPI2
PB15 SPI2_MOSI SPI2

# SPI4 - SDCARD
PE2 SPI4_SCK SPI4
PE13 SPI4_MISO SPI4
PE14 SPI4_MOSI SPI4

# SPI6 - external sensors
PA5 SPI6_SCK SPI6
PA6 SPI6_MISO SPI6
PA7 SPI6_MOSI SPI6

# CS pins
PD10 BMI270_CS CS
PC14 LPS22HB_CS CS
PC13 BMP280_CS CS
PE4 ICM42688_CS CS
PE3 SDCARD_CS CS
#PE11 SPI6_CS1 CS
#PE12 SPI6_CS2 CS

# DRDY pins
PE15 ICM42688P_DRDY INPUT
PD11 BMI270_DRDY INPUT
PC15 LPS22HB_DRDY INPUT

# two I2C bus
I2C_ORDER I2C2 I2C4

# I2C4
PD12 I2C4_SCL I2C4
PD13 I2C4_SDA I2C4

# I2C2
PB10 I2C2_SCL I2C2
PB11 I2C2_SDA I2C2

# ADC
PC0 BATT_VOLTAGE_SENS ADC1 SCALE(1)
PC1 BATT_CURRENT_SENS ADC1 SCALE(1)
PC2 BATT2_VOLTAGE_SENS ADC1 SCALE(1)
PC3 BATT2_CURRENT_SENS ADC1 SCALE(1)

define HAL_BATT_MONITOR_DEFAULT 4
define HAL_BATT_VOLT_PIN 10
define HAL_BATT_CURR_PIN 11
define HAL_BATT2_VOLT_PIN 18
define HAL_BATT2_CURR_PIN 7
define HAL_BATT_VOLT_SCALE 11.0
define HAL_BATT_CURR_SCALE 40.0
define HAL_BATT2_VOLT_SCALE 11.0

PC4 PRESSURE_SENS ADC1 SCALE(2)
define HAL_DEFAULT_AIRSPEED_PIN 4

PC5 RSSI_ADC ADC1
define BOARD_RSSI_ANA_PIN 8

PA4 HEATER_EN OUTPUT LOW GPIO(80)
define HAL_HEATER_GPIO_PIN 80
define HAL_HAVE_IMU_HEATER 1

# LED
# green LED1 marked as B/E
# blue LED0 marked as ACT
PB12 LED1 OUTPUT HIGH GPIO(91) # green
PB2 LED0 OUTPUT HIGH GPIO(90) # blue
define HAL_GPIO_A_LED_PIN 91
define HAL_GPIO_B_LED_PIN 90

# order of UARTs (and USB)
# OTG1 and OTG2 are USB devices (1x physical USB connection enumerated as 2x logical ports)
SERIAL_ORDER OTG1 UART7 USART2 USART1 USART3 UART8 UART4 UART5 OTG2

# default the 2nd interface to MAVLink2 until MissionPlanner updates drivers
define HAL_OTG2_PROTOCOL SerialProtocol_MAVLink2

# UART7 (telem1)
PE7 UART7_RX UART7
PE8 UART7_TX UART7
PE10 UART7_CTS UART7
PE9  UART7_RTS UART7

# USART2 (telem2)
PD3 USART2_CTS USART2
PD4 USART2_RTS USART2
PD5 USART2_TX USART2
PD6 USART2_RX USART2

# USART1 (GPS1)
PA10 USART1_RX USART1
PA9  USART1_TX USART1

# USART3 (GPS2)
PD9 USART3_RX USART3
PD8 USART3_TX USART3

# UART8 (spare)
PE0 UART8_RX UART8
PE1 UART8_TX UART8

# UART4 (spare)
PC11 UART4_RX UART4
PC10 UART4_TX UART4

# UART5 (spare)
PD2 UART5_RX UART5
PC12 UART5_TX UART5

# RC input
PA15 TIM2_CH1 TIM2 RCININT PULLDOWN LOW
# as an alternative config setup the RX6 pin as a uart. This allows
# for bi-directional UART based receiver protocols such as FPort
# without any extra hardware using BRD_ALT_CONFIG=1
PD2 UART5_RX UART5 NODMA ALT(1)

# Beeper
PA8 TIM1_CH1 TIM1 GPIO(32) ALARM

# CAN bus
PD0 CAN1_RX CAN1
PD1 CAN1_TX CAN1

# 2nd CAN bus. Cannot be used at same time as USB_HS
PB5 CAN2_RX CAN2
PB6 CAN2_TX CAN2

# Motors
PB0  TIM8_CH2N TIM8  PWM(1)  GPIO(50)
PB1  TIM8_CH3N TIM8  PWM(2)  GPIO(51)
PA0  TIM5_CH1  TIM5  PWM(3)  GPIO(52)
PA1  TIM5_CH2  TIM5  PWM(4)  GPIO(53)
PA2  TIM5_CH3  TIM5  PWM(5)  GPIO(54)
PA3  TIM5_CH4  TIM5  PWM(6)  GPIO(55)
PB8  TIM16_CH1 TIM16 PWM(7)  GPIO(66)
PB7  TIM4_CH2  TIM4  PWM(8)  GPIO(57)
PD14 TIM4_CH3  TIM4  PWM(9)  GPIO(58)
PD15 TIM4_CH4  TIM4  PWM(10) GPIO(59)
PE5  TIM15_CH1 TIM15 PWM(11) GPIO(60)
PE6  TIM15_CH2 TIM15 PWM(12) GPIO(61)
PC6  TIM3_CH1  TIM3  PWM(13) GPIO(62)
PC7  TIM3_CH2  TIM3  PWM(14) GPIO(63)
PC8  TIM3_CH3  TIM3  PWM(15) GPIO(64)
PC9  TIM3_CH4  TIM3  PWM(16) GPIO(65)

DMA_PRIORITY S*

define HAL_STORAGE_SIZE 16384

# use last 2 pages for flash storage
# H743 has 16 pages of 128k each
STORAGE_FLASH_PAGE 14

# SPI devices
SPIDEV bmi270       SPI1 DEVID1 BMI270_CS  MODE3  10*MHZ  10*MHZ
SPIDEV icm42688     SPI2 DEVID1 ICM42688_CS MODE3  2*MHZ  16*MHZ
SPIDEV lps22h       SPI1 DEVID2 LPS22HB_CS MODE3 1*MHZ 10*MHZ
SPIDEV bmp280       SPI2 DEVID2 BMP280_CS MODE3 1*MHZ 8*MHZ
SPIDEV sdcard       SPI4 DEVID1 SDCARD_CS MODE0 400*KHZ 25*MHZ

DMA_NOSHARE SPI1* SPI4*

# SPI6 external connections
# SPIDEV pixartflow   SPI6 DEVID1  EXT_CS1  MODE3   2*MHZ  2*MHZ

# two Compass
COMPASS BMM150 I2C:0:0x10 false ROTATION_NONE
COMPASS LIS3MDL I2C:0:0x1C false ROTATION_NONE

# probe the i2c bus for all possible
define HAL_PROBE_EXTERNAL_I2C_COMPASSES
# by default first I2C bus is internal
define HAL_I2C_INTERNAL_MASK 1

# two IMU
IMU BMI270 SPI:bmi270 ROTATION_ROLL_180_YAW_270
IMU Invensensev3 SPI:icm42688 ROTATION_NONE

# two baro
BARO BMP280 SPI:bmp280
BARO LPS2XH SPI:lps22h

define HAL_OS_FATFS_IO 1
define HAL_BOARD_LOG_DIRECTORY "/APM/LOGS"
define HAL_BOARD_TERRAIN_DIRECTORY "/APM/TERRAIN"